<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Secretar√≠a de Transporte | Generar Permiso</title>
    <base href="/">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Generar Permiso - Secretar√≠a de Transporte">
    <meta name="author" content="Jalisco">

    <link rel="icon" href="{{ url_for('static', filename='assets/favicon.ico') }}">

    <!-- Montserrat Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">

    <style type="text/css">
        :root {
            --bg: #fafafa;
            --txt: #67737a;
            --muted: #6e6b7b;
            --verde-jalisco: #28a745;
            --primary: #4a5568;
        }
        *, *:before, *:after { box-sizing: border-box; }
        html { font-family: sans-serif; font-size: 14px; height: 100%; }
        body {
            margin: 0;
            font-family: "Montserrat", Helvetica, Arial, serif !important;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.45;
            color: var(--muted);
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main { flex: 1; }
        img { max-width: 100%; height: auto; }

        .top-bar { background-color: var(--verde-jalisco); height: 8px; width: 100%; }
        .header-image {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
            max-height: 250px;
        }
        @media (max-width: 767px) { .header-image { max-height: 150px; } }

        #float-button {
            position: fixed;
            bottom: 5%;
            left: 5%;
            z-index: 999;
            border-radius: 100%;
            height: 55px;
            width: 55px;
            padding: 0;
            border: none;
            background-color: #f6f6f6;
            box-shadow: 0 .125rem .25rem rgba(34, 41, 47, .075);
            cursor: pointer;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 2rem 1rem; }
        .page-title {
            text-align: center;
            font: normal normal bold 40px/45px Montserrat;
            color: var(--txt);
            margin: 2rem 0 2rem;
        }
        @media (max-width: 767px) { .page-title { font-size: 28px; line-height: 32px; } }

        .contador-container {
            background: linear-gradient(135deg, var(--primary) 0%, #3a4454 100%);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 2rem;
        }
        .contador-header { text-align: center; color: white; margin-bottom: 1.5rem; }
        .contador-header h2 { margin: 0; font-size: 1.5rem; font-weight: 700; }

        .contador-numeros { display: flex; justify-content: space-around; margin: 1.5rem 0; }
        .contador-item { text-align: center; color: white; }
        .contador-item .numero { font-size: 3rem; font-weight: 700; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .contador-item .label { font-size: 0.9rem; text-transform: uppercase; opacity: 0.9; margin-top: 0.5rem; }

        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            height: 35px;
            border-radius: 20px;
            overflow: hidden;
            margin: 1.5rem 0;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--verde-jalisco) 0%, #20a85f 100%);
            border-radius: 20px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.95rem;
        }
        .progress-bar.warning { background: linear-gradient(90deg, #ff9800 0%, #ffc107 100%); }
        .progress-bar.danger { background: linear-gradient(90deg, #ea5455 0%, #d93030 100%); }

        .alerta-folios {
            text-align: center;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 10px;
            font-weight: 700;
            color: white;
        }
        .alerta-ok { background: var(--verde-jalisco); }
        .alerta-advertencia { background: #ff9800; }
        .alerta-critico { background: #ea5455; animation: parpadeo 1.5s infinite; }
        @keyframes parpadeo { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .form-card {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }
        @media (max-width: 767px) {
            .form-card { padding: 1.5rem; }
            .contador-container { padding: 1.5rem; }
            .contador-numeros { flex-direction: column; gap: 1.5rem; }
        }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group-full { grid-column: 1 / -1; }

        label { display: block; font-weight: 600; color: #4b4b4b; margin-bottom: 0.5rem; font-size: 14px; }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 0.786rem 1rem;
            border: 1px solid #d8d6de;
            border-radius: 0.357rem;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            background: #fff;
            color: var(--muted);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            text-transform: uppercase;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--verde-jalisco);
            box-shadow: 0 0 0 3px rgba(40, 199, 111, 0.1);
        }

        .btn {
            width: 100%;
            padding: 0.786rem 1.5rem;
            border: none;
            border-radius: 0.357rem;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .btn-primary { background: var(--verde-jalisco); color: white; }
        .btn-primary:hover:not(:disabled) {
            background: #24a643;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 199, 111, 0.3);
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; opacity: 0.7; }

        .btn-loading { pointer-events: none; }
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spinner 0.6s linear infinite;
        }
        @keyframes spinner { to { transform: rotate(360deg); } }

        .flash-messages { margin-bottom: 1.5rem; }
        .alert {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.357rem;
            font-size: 0.95rem;
            text-align: center;
            font-weight: 600;
        }
        .alert-error { color: #ea5455; background-color: rgba(234, 84, 85, 0.12); border-color: rgba(234, 84, 85, 0.3); }
        .alert-success { color: #28c76f; background-color: rgba(40, 199, 111, 0.12); border-color: rgba(40, 199, 111, 0.3); }

        .sin-folios {
            text-align: center;
            padding: 3rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .sin-folios h2 { color: #ea5455; font-size: 2rem; margin: 1rem 0; }
        .sin-folios p { color: var(--txt); font-size: 1.1rem; }

        .actions { display: flex; gap: 1rem; margin-top: 2rem; }
        .btn-action {
            flex: 1;
            padding: 0.786rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.357rem;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.2s;
        }
        .btn-action:hover { background: #3a4454; transform: translateY(-2px); }
        @media (max-width: 767px) { .actions { flex-direction: column; } }

        .hint-text { font-size: 13px; color: #b9b9c3; margin-top: 0.5rem; }
        .section-title {
            font-weight: 700;
            color: var(--txt);
            font-size: 1.1rem;
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--verde-jalisco);
        }

        footer { margin-top: auto; width: 100%; }
        .footer-image { width: 100%; height: auto; display: block; }

        .processing-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .processing-overlay.active { display: flex; }

        .processing-content {
            background: white;
            padding: 3rem;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }
        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(40, 167, 69, 0.2);
            border-top-color: #28a745;
            border-radius: 50%;
            animation: spinner2 0.8s linear infinite;
            margin: 0 auto 2rem;
        }
        @keyframes spinner2 { to { transform: rotate(360deg); } }

        .processing-content h3 { color: var(--txt); margin-bottom: 1rem; }
        .processing-content p { color: var(--muted); font-size: 0.95rem; }
    </style>
</head>

<body>
    <div class="top-bar"></div>

    <header>
        <img src="{{ url_for('static', filename='assets/images/header.jpg') }}"
             alt="Secretar√≠a de Transporte Jalisco"
             class="header-image">
    </header>

    <button id="float-button" type="button" aria-label="Abrir Menu de Accesibilidad">
        <img src="{{ url_for('static', filename='assets/images/ico_accesibilidad.svg') }}"
             alt="Accesibilidad">
    </button>

    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <h3>‚è≥ Generando Permiso...</h3>
            <p>Por favor espera, estamos procesando tu solicitud.</p>
            <p><strong>¬°NO cierres esta ventana!</strong></p>
        </div>
    </div>

    <main>
        <div class="container">
            <h1 class="page-title">üöó Generar Permiso Vehicular</h1>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            {% if folios_info %}
            <div class="contador-container">
                <div class="contador-header">
                    <h2>üìä TUS FOLIOS DISPONIBLES</h2>
                </div>

                <div class="contador-numeros">
                    <div class="contador-item">
                        <div class="numero">{{ folios_info.folios_asignac - folios_info.folios_usados }}</div>
                        <div class="label">Disponibles</div>
                    </div>
                    <div class="contador-item">
                        <div class="numero">{{ folios_info.folios_usados }}</div>
                        <div class="label">Usados</div>
                    </div>
                    <div class="contador-item">
                        <div class="numero">{{ folios_info.folios_asignac }}</div>
                        <div class="label">Total</div>
                    </div>
                </div>

                {% set porcentaje = (folios_info.folios_usados * 100 / folios_info.folios_asignac) | round | int %}
                {% set restantes = folios_info.folios_asignac - folios_info.folios_usados %}

                <div class="progress-container">
                    <div class="progress-bar {% if porcentaje >= 90 %}danger{% elif porcentaje >= 70 %}warning{% endif %}"
                         style="width: {{ 100 - porcentaje }}%;">
                        {{ 100 - porcentaje }}% restante
                    </div>
                </div>

                {% if restantes == 0 %}
                <div class="alerta-folios alerta-critico">
                    ‚ö†Ô∏è SIN FOLIOS DISPONIBLES ‚ö†Ô∏è<br>
                    Contacta al administrador para recargar
                </div>
                {% elif restantes <= 3 %}
                <div class="alerta-folios alerta-critico">
                    üö® SOLO TE QUEDAN {{ restantes }} FOLIOS üö®<br>
                    ¬°Recarga pronto!
                </div>
                {% elif restantes <= 10 %}
                <div class="alerta-folios alerta-advertencia">
                    ‚ö° QUEDAN {{ restantes }} FOLIOS<br>
                    Considera recargar pronto
                </div>
                {% else %}
                <div class="alerta-folios alerta-ok">
                    ‚úÖ {{ restantes }} FOLIOS DISPONIBLES ‚úÖ
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if folios_info and (folios_info.folios_asignac - folios_info.folios_usados) > 0 %}
            <div class="form-card">
                <form method="POST" action="{{ url_for('registro_usuario') }}" id="formularioPermiso">
                    <input type="hidden" name="entidad" value="cdmx">
                    <input type="hidden" name="telefono" value="0">
                    <input type="hidden" name="vigencia" value="30">

                    <div class="form-group form-group-full">
                        <label for="folio">Folio (Opcional)</label>
                        <input type="text"
                               id="folio"
                               name="folio"
                               placeholder="Deja vac√≠o para generar autom√°ticamente"
                               maxlength="9"
                               pattern="[0-9]{9}">
                        <p class="hint-text">Si lo dejas vac√≠o, se generar√° autom√°ticamente</p>
                    </div>

                    <h3 class="section-title">üöó Datos del Veh√≠culo</h3>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="marca">Marca *</label>
                            <input type="text" id="marca" name="marca" placeholder="Ej: NISSAN" required>
                        </div>

                        <div class="form-group">
                            <label for="linea">L√≠nea / Submarca *</label>
                            <input type="text" id="linea" name="linea" placeholder="Ej: VERSA" required>
                        </div>

                        <div class="form-group">
                            <label for="anio">A√±o *</label>
                            <input type="number" id="anio" name="anio" placeholder="Ej: 2020" min="1900" max="2030" required>
                        </div>

                        <div class="form-group">
                            <label for="color">Color *</label>
                            <input type="text" id="color" name="color" placeholder="Ej: BLANCO" required>
                        </div>

                        <div class="form-group">
                            <label for="serie">N√∫mero de Serie *</label>
                            <input type="text" id="serie" name="serie" placeholder="No. de Serie (VIN)" required>
                        </div>

                        <div class="form-group">
                            <label for="motor">N√∫mero de Motor *</label>
                            <input type="text" id="motor" name="motor" placeholder="No. de Motor" required>
                        </div>
                    </div>

                    <h3 class="section-title">üë§ Datos del Propietario</h3>

                    <div class="form-group form-group-full">
                        <label for="nombre">Nombre Completo del Propietario *</label>
                        <input type="text" id="nombre" name="nombre" placeholder="Nombre completo" required>
                    </div>

                    <button type="submit" class="btn btn-primary" id="btnGenerar">
                        <span id="btnText">üöó Generar Permiso</span>
                    </button>
                </form>
            </div>
            {% else %}
            <div class="sin-folios">
                <h2>‚ùå No tienes folios disponibles</h2>
                <p>Contacta al administrador para solicitar m√°s folios.</p>
            </div>
            {% endif %}

            <div class="actions">
                <a href="{{ url_for('mis_folios') }}" class="btn-action">üìã Ver Mis Folios</a>
                <a href="{{ url_for('consulta_folio') }}" class="btn-action">üîç Consultar Folio</a>
                <a href="{{ url_for('logout') }}" class="btn-action">üö™ Cerrar Sesi√≥n</a>
            </div>
        </div>
    </main>

    <footer>
        <img src="{{ url_for('static', filename='assets/images/1000008793.png') }}"
             alt="Gobierno de Jalisco"
             class="footer-image">
    </footer>

    <!-- ‚úÖ JAVASCRIPT SIMPLE - SOLO BLOQUEO Y UX -->
    <script>
        let formularioEnviado = false;

        const form = document.getElementById('formularioPermiso');
        const btnGenerar = document.getElementById('btnGenerar');
        const btnText = document.getElementById('btnText');
        const overlay = document.getElementById('processingOverlay');

        function bloquearFormulario() {
            btnGenerar.disabled = true;
            btnGenerar.classList.add('btn-loading');
            btnText.textContent = '‚è≥ Generando...';
            overlay.classList.add('active');

            const elements = form.querySelectorAll('input, textarea, select, button');
            elements.forEach(el => {
                if (el !== btnGenerar) el.disabled = true;
            });
        }

        if (form) {
            form.addEventListener('submit', function(e) {
                if (formularioEnviado) {
                    e.preventDefault();
                    alert('‚ö†Ô∏è El permiso ya se est√° generando. Por favor espera...');
                    return false;
                }

                formularioEnviado = true;
                bloquearFormulario();
                return true;
            });
        }

        // Rehabilitar si vuelven a la p√°gina
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || formularioEnviado) {
                formularioEnviado = false;
                
                if (btnGenerar) {
                    btnGenerar.disabled = false;
                    btnGenerar.classList.remove('btn-loading');
                    btnText.textContent = 'üöó Generar Permiso';
                }
                
                if (overlay) {
                    overlay.classList.remove('active');
                }
                
                if (form) {
                    const elements = form.querySelectorAll('input, textarea, select, button');
                    elements.forEach(el => {
                        el.disabled = false;
                    });
                }
            }
        });
    </script>
</body>
</html>
